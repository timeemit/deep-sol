<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sol Glyph</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <body>
		<h1 class="text-3xl text-center">Sol Glyph</h1>
    <div class="flex flex-row flex-wrap text-center">
      <div class="basis-1/5">
        <div class="mx-auto w-16 h-16">
          <canvas id="left"></canvas>
        </div>
      </div>
      <div class="basis-1/5">
        <div class="mx-auto w-16 h-16">
          <canvas id="center-left"></canvas>
        </div>
      </div>
      <div class="basis-1/5">
        <div class="mx-auto w-16 h-16">
          <canvas id="center"></canvas>
        </div>
      </div>
      <div class="basis-1/5">
        <div class="mx-auto w-16 h-16">
            <canvas id="center-right"></canvas>
        </div>
      </div>
      <div class="basis-1/5">
        <div class="mx-auto w-16 h-16">
          <canvas id="right"></canvas>
        </div>
      </div>
      <div class="basis-1/5">A Randomly Generated Image (A)</div>
      <div class="basis-3/5">Images "Between" A &amp; B</div>
      <div class="basis-1/5">A Randomly Generated Image (B)</div>
    </div>
    <h2 class="text-xl text-center">You're Looking at Images Generated<br />Entirely on a Solana Blockchain<br />Using a Trained Machine Learning Model</h2>
    <script>
      // Standard Normal variate using Box-Muller transform.
      function randn() {
        var u = 0, v = 0;
        while(u === 0) u = Math.random(); //Converting [0,1) to (0,1)
        while(v === 0) v = Math.random();
        return Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v );
      }

      function randArray(size) {
        return Array(size).fill(0).map(randn);
      }

      function range(data) {
        min = 0;
        max = 0;
        data.forEach((datum) => {
          min = Math.min(datum, min);
          max = Math.max(datum, max);
        });
        return {min, max};
      }

      function rescale(val, srcMin, srcMax, dstMin, dstMax) {
        return (((val - srcMin) / srcMax) + dstMin) * dstMax;
      }

      function drawImage(target, values) {
        jQuery.ajax({
          url: "/img",
          type: "POST",
          data: JSON.stringify({ values: values }),
          contentType: "application/json",
          dataType: "json",
          success: function (data) {
            console.log('Success! Rendering', data.result);
            var canvas = document.getElementById(target);
            var ctx = canvas.getContext('2d');
            console.log(ctx);
            var imageData = ctx.createImageData(64, 64);
            console.log(imageData);

            var domain = range(data.result);
            console.log(domain);

            // Caution: this can make your eyes bleed
            const ALPHA_CHANNEL = 3
            const RGBA_CHANNELS = 4
            const INPUT_HEIGHT = 8;
            const INPUT_WIDTH = 8;
            const OUTPUT_HEIGHT = 64;
            const OUTPUT_WIDTH = 64;
            const OUTPUT_SCALE = 8;
            for (var h = 0; h < INPUT_HEIGHT; h++) {
              for (var w = 0; w < INPUT_WIDTH; w++) {
                for (var c = 0; c < RGBA_CHANNELS; c++) {
                  var input_index = c * (INPUT_HEIGHT * INPUT_WIDTH) + h * INPUT_WIDTH + w;
                  if (c !== ALPHA_CHANNEL) {
                    console.log(input_index);
                    console.log(data.result[input_index]);
                    console.log(rescale(
                      data.result[input_index],
                      domain.min,
                      domain.max,
                      0,
                      255,
                    ));
                  }
                  for (var ix = 0; ix < OUTPUT_SCALE; ix++) {
                    for (var iy = 0; iy < OUTPUT_SCALE; iy++) {
                      var new_w = parseInt(rescale(w, 0, 8, 0, 64));
                      var new_h = parseInt(rescale(h, 0, 8, 0, 64));
                      var output_index = (new_h + iy) * (OUTPUT_WIDTH * RGBA_CHANNELS) + (new_w + ix) * RGBA_CHANNELS + c;
                      // console.log(output_index);
                      if (c === ALPHA_CHANNEL) {
                        // Alpha channel
                        imageData.data[output_index] = 255;
                      } else {
                        // imageData.data[output_index] = Math.random() * 255;
                        // imageData.data[output_index] = 0;
                        imageData.data[output_index] = rescale(
                          data.result[input_index],
                          domain.min,
                          domain.max,
                          0,
                          255,
                        );
                      }
                    }
                  }
                }
              }
            }
            // for(var i = 0; i < imageData.data.length; i++) {
            //   imageData.data[i] = Math.random() * 255;
            // }

            console.log(imageData);

            // draw newly modified pixels back onto the canvas
            ctx.putImageData(imageData, 0, 0);
          },
        });
      }

      function drawImages() {
        drawImage("left", randArray(10));
        drawImage("right", randArray(10));
      }

      $.when($.ready).then(drawImages);
    </script>
  </body>
</html>
